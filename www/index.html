<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
       body {
         font-family: 'Open Sans', sans-serif
       }
       #relays {
         width: 500px;
         max-width: 90vw;
         margin: 0 auto;
         line-height: 2em
       }
       button {
         float: right
       }
       h1 {
         margin: 0 auto;
         text-align: center
       }
    </style>
  </head>
  <body>
    <h1>Relay control</h1>
    <br>
    <div id="relays"></div>
  </body>
  <footer>
    <script>
      let fetch_relays
      const switch_relay = async (relay, mode) => {
        relays.innerHTML = ''
        let resp = await fetch(`/relay?${mode}=${relay}`)
        if (resp.ok) {
          resp = await resp.text()
          alert(resp)
        } else {
          alert(`HTTP error ${resp.status}`)
        }
        fetch_relays()
      }
      (async () => {
        let relays = document.getElementById('relays')
        fetch_relays = async () => {
          let resp = await fetch('/relay?status=csv')
          if (resp.ok) {
            resp = await resp.text()
          } else {
            return -1
          }
          resp = resp.split('\n')
          for (let i = 1; i < resp.length - 1; i++) {
            let relay = resp[i].split(',')
            relays.innerHTML += `<div id="relay${relay[0]}"><b>${relay[2]}</b> GPIO pin ${relay[0]} Status: <b>${(() => {
             if (relay[1] === '0') {
               return `<span style="color:green">OPEN</span><button onclick="switch_relay(${relay[0]}, 'on')">Close</button>`
             }
             else {
               return `<span style="color:red">CLOSED</span><button onclick="switch_relay(${relay[0]}, 'off')">Open</button>`
             }
           })()}</b></div>`
          }
        }
        fetch_relays()
      })()
    </script>
  </footer>
</html>
